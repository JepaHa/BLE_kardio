# BLE_Kardio - Bluetooth Heart Rate Monitor

Проект BLE периферийного устройства на базе Zephyr RTOS, реализующего сервис Heart Rate Service (HRS) для симуляции монитора сердечного ритма.

## Описание проекта

Устройство работает как BLE периферийное устройство (peripheral), которое:
- Рекламирует себя как "BLE_Kardio" через Bluetooth Low Energy
- Предоставляет сервис Heart Rate Service (HRS) согласно спецификации Bluetooth SIG
- Симулирует передачу данных о сердечном ритме (90-160 bpm)
- Автоматически управляет рекламой при подключении/отключении клиентов
- Использует безопасное отложенное логирование для всех Bluetooth событий

## Архитектура проекта

### Основные компоненты

#### 1. **main.c** - Точка входа
- Инициализирует BLE стек через `ble_init()`
- Управляет LED индикатором (опционально)

#### 2. **BLE/ble_init.c** - Инициализация Bluetooth
- Инициализирует BLE стек
- Регистрирует колбэки для событий подключения/отключения
- Управляет жизненным циклом рекламы:
  - **При подключении**: останавливает рекламу (устройство уже подключено)
  - **При отключении**: перезапускает рекламу с задержкой 100мс (дает стеку время освободить ресурсы)
- Инициализирует HRS сервис

#### 3. **BLE/ble_advertising.c** - Управление рекламой
- Управляет состоянием BLE рекламы
- Отслеживает активность рекламы через флаг `advertising_active`
- Обрабатывает ошибки при остановке/запуске рекламы

#### 4. **BLE/ble_log.c** - Отложенное логирование
- **Проблема**: Прямое логирование (`LOG_INF`, `printk`) из колбэков Bluetooth может вызывать падение ядра, так как колбэки могут вызываться из контекста прерываний (ISR)
- **Решение**: Все логирование выполняется через отложенную работу (`k_work_delayable`), которая выполняется в контексте рабочего потока
- Функции:
  - `ble_log_connected()` - логирование подключения
  - `ble_log_disconnected()` - логирование отключения
  - `ble_log_security_changed()` - логирование изменения безопасности
  - `ble_log_info()` - общее информационное логирование
  - `ble_log_error()` - логирование ошибок

#### 5. **BLE/GATT/hrs.c** - Heart Rate Service
- Реализует стандартный HRS сервис Bluetooth SIG
- **Характеристики**:
  - **Heart Rate Measurement** (Notify) - передача данных о пульсе
  - **Body Sensor Location** (Read) - местоположение датчика (Chest/0x01)
  - **Heart Rate Control Point** (Write) - контрольная точка (зарезервировано)
- **Симуляция сердцебиения**:
  - При включении уведомлений клиентом запускается таймер
  - Каждую секунду отправляется новое значение пульса
  - Пульс изменяется от 90 до 160 bpm с инкрементом 1
  - При достижении 160 bpm сбрасывается до 90 bpm
- **Формат данных**: согласно спецификации HRS
  - Byte 0: Флаги (0x06 = UINT8 формат, контакт датчика обнаружен)
  - Byte 1: Значение пульса (UINT8)

## Поток работы

### Инициализация
1. `main()` вызывает `ble_init()`
2. Инициализируется модуль отложенного логирования
3. Инициализируется отложенная работа для перезапуска рекламы
4. Включается BLE стек (`bt_enable()`)
5. Инициализируется HRS сервис с локацией датчика "Chest" (0x01)
6. Запускается BLE реклама

### Подключение клиента
1. Клиент сканирует и находит устройство "BLE_Kardio"
2. Клиент подключается к устройству
3. Вызывается колбэк `connected()`:
   - Отменяется запланированный перезапуск рекламы (если был)
   - Останавливается реклама (устройство уже подключено)
   - Устанавливается соединение для HRS сервиса
   - При необходимости запрашивается повышение уровня безопасности до L2
4. Клиент может подписаться на уведомления Heart Rate Measurement
5. При подписке запускается таймер для периодической отправки данных

### Работа с подключенным клиентом
1. Каждую секунду таймер вызывает `hrs_notify()`
2. Значение пульса увеличивается на 1
3. Данные отправляются клиенту через `bt_gatt_notify()`
4. Все события логируются через отложенное логирование

### Отключение клиента
1. Клиент отключается
2. Вызывается колбэк `disconnected()`:
   - Очищается соединение для HRS сервиса
   - Останавливается таймер отправки данных (если был активен)
   - Планируется перезапуск рекламы через 100мс
3. Через 100мс выполняется отложенная работа `adv_restart_work_handler()`:
   - Пытается запустить рекламу
   - При ошибке (например, -12 ENOMEM) повторяет попытку через 500мс
   - При успехе логирует успешный перезапуск
4. Устройство снова доступно для подключения

## Конфигурация

### prj.conf
- **Bluetooth**: Включен периферийный режим, имя устройства "BLE_Kardio"
- **Логирование**: Отложенный режим (`CONFIG_LOG_MODE_DEFERRED`) для безопасности в ISR контексте
- **Entropy**: Используется ESP32 RNG для генерации случайных чисел (требуется для BLE)

## Особенности реализации

### Безопасное логирование
Все логирование Bluetooth событий выполняется через отложенную работу, что предотвращает падение ядра при вызове из контекста прерываний.

### Управление рекламой
- Реклама автоматически останавливается при подключении
- Реклама перезапускается с задержкой после отключения для корректной работы стека
- При ошибке перезапуска выполняется автоматический повтор

### Симуляция HRS
- Реализована согласно спецификации Bluetooth SIG Heart Rate Service
- Поддерживает стандартные характеристики и дескрипторы
- Автоматическая отправка данных при подписке клиента

# Установка зависимостей

Следовать этой [инструкции](https://docs.zephyrproject.org/latest/develop/getting_started/index.html#install-dependencies)
из документации Zephyr.

# Развертывание workspace

В этой папке выполняем следующие команды:

#### С помощью uv

#### Linux/Mac

```sh
uv venv
. .venv/bin/activate
```

#### Windows

```sh
uv venv
. .venv/Scripts/activate
```

### С помощью pip

#### Linux/Mac

```sh
python -m venv .venv
. .venv/bin/activate
```

#### Windows

```sh
python -m venv .venv
. .venv/Scripts/activate
```

## Скачивание дистрибутива и модулей Zephyr

### С помощью uv

```sh
uv pip install west
west update
uv pip install -r deps/zephyr/zephyr/scripts/requirements.txt
west update
```

### С помощью pip

```sh
pip install west
west update
pip install -r deps/zephyr/zephyr/scripts/requirements.txt
west update
```

## Установка Zephyr SDK через west

```sh
west sdk install
```

Zephyr SDK скачается и установится в папку `$HOME/zephyr-sdk-<версия>/`.


# Образ прошивки

## Сборка

```sh
west build -b <плата> app
```

Собранный файл находится по пути: `build/zephyr/zephyr.bin`

## Прошивка

```sh
west flash
```

